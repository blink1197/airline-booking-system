<script setup>
import DatePicker from '@/components/common/DatePicker.vue';
import DestinationSelect from '@/components/common/DestinationSelect.vue';
import PaxCabinPicker from '@/components/common/PaxCabinPicker.vue';
import { destinations } from '@/data/destinations';
import { useFlightSearchStore } from '@/stores/flightSearch';
import { reactive, ref, watch } from 'vue';

const emit = defineEmits(['search']);

const flightStore = useFlightSearchStore();
const isReturnDateDisabled = ref(flightStore.tripType === 'oneWayTrip');

// --- Form state ---
const form = reactive({
  tripType: flightStore.tripType,
  from: flightStore.from,
  to: flightStore.to,
  departureDate: flightStore.departureDate,
  returnDate: flightStore.returnDate,
  paxCabin: {
    pax: flightStore.pax,
    cabin: flightStore.cabin,
  },
});

// --- Validation errors ---
const errors = reactive({
  from: '',
  to: '',
  departureDate: '',
  returnDate: '',
});

// --- Watchers ---
watch(
  () => form.tripType,
  (val) => {
    isReturnDateDisabled.value = val === 'oneWayTrip';
    if (val === 'oneWayTrip') {
      form.returnDate = '';
      errors.returnDate = '';
    }
  }
);

watch(
  () => ({ ...form }),
  (newForm) => {
    if (newForm.from) errors.from = '';
    if (newForm.to) errors.to = '';
    if (newForm.departureDate) errors.departureDate = '';
    if (newForm.tripType === 'roundTrip' && newForm.returnDate) errors.returnDate = '';
  },
  { deep: true }
);

// --- Functions ---
function validateForm() {
  let valid = true;
  errors.from = '';
  errors.to = '';
  errors.departureDate = '';
  errors.returnDate = '';

  if (!form.from) { errors.from = 'Departure cannot be empty'; valid = false; }
  if (!form.to) { errors.to = 'Destination cannot be empty'; valid = false; }
  if (!form.departureDate) { errors.departureDate = 'Departure date cannot be empty'; valid = false; }
  if (form.tripType === 'roundTrip' && !form.returnDate) { errors.returnDate = 'Return date cannot be empty'; valid = false; }

  return valid;
}

function submitForm() {
  if (!validateForm()) return;

  // Update store
  flightStore.setFlightSearchData({
    ...form,
    pax: form.paxCabin.pax,
    cabin: form.paxCabin.cabin,
  });

  emit('search', { ...form });
}
</script>

<template>
  <form class="hero-form bg-white p-3 p-lg-5 mx-auto" @submit.prevent="submitForm">
    <div class="row g-3">
      <!-- Trip Type -->
      <div class="col-12 d-flex gap-4">
        <div class="form-check">
          <input class="form-check-input" type="radio" id="oneWayTrip" value="oneWayTrip" v-model="form.tripType" />
          <label class="form-check-label" for="oneWayTrip">One Way</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" id="roundTrip" value="roundTrip" v-model="form.tripType" />
          <label class="form-check-label" for="roundTrip">Round Trip</label>
        </div>
      </div>

      <!-- Departure -->
      <div class="col-12 col-md-6 mt-2">
        <DestinationSelect label="Departure" v-model="form.from" :options="destinations" placeholder="From" />
        <div class="text-danger small" style="min-height:1.5em">{{ errors.from }}</div>
      </div>

      <!-- Destination -->
      <div class="col-12 col-md-6 mt-2">
        <DestinationSelect label="Destination" v-model="form.to" :options="destinations" placeholder="To" />
        <div class="text-danger small" style="min-height:1.5em">{{ errors.to }}</div>
      </div>

      <!-- Departure Date -->
      <div class="col-12 col-md-6 mt-2">
        <DatePicker label="Departure Date" v-model="form.departureDate" />
        <div class="text-danger small" style="min-height:1.5em">{{ errors.departureDate }}</div>
      </div>

      <!-- Return Date -->
      <div class="col-12 col-md-6 mt-2">
        <DatePicker label="Return Date" v-model="form.returnDate" :is-disabled="isReturnDateDisabled" />
        <div class="text-danger small" style="min-height:1.5em">{{ errors.returnDate }}</div>
      </div>

      <!-- Passengers & Cabin -->
      <div class="col-12 col-md-6 col-lg-4">
        <PaxCabinPicker v-model="form.paxCabin" />
      </div>

      <!-- Submit -->
      <div class="col-12 col-md-6 col-lg-4 ms-md-auto">
        <button type="submit"
          class="btn btn-primary py-3 py-md-2 w-100 fw-bold d-flex justify-content-center gap-2 align-items-center">
          <i class="bi bi-search"></i>
          <span>Search Flight</span>
        </button>
      </div>
    </div>
  </form>
</template>

<style scoped>
.hero-form {
  color: var(--color-primary) !important;
  box-shadow: var(--shadow-card);
  border-radius: 15px;
  max-width: 1000px;
}

.hero-form .form-label {
  color: var(--color-primary) !important;
}

.hero-form .form-control {
  border: 0;
  background-color: var(--color-gray-6);
  text-align: center;
}
</style>
