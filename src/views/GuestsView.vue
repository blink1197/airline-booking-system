<script setup>
import ProgressBar from '@/components/common/ProgressBar.vue'
import ContactInfoForm from '@/components/forms/ContactInfoForm.vue'
import PassengerForm from '@/components/forms/PassengerForm.vue'
import StickyButtonGroup from '@/components/ui/StickyButtonGroup.vue'
import VerticalTabs from '@/components/ui/VerticalTabs.vue'

import { useContactStore } from '@/stores/contact'
import { useFlightSearchStore } from '@/stores/flightSearch'
import { usePassengersStore } from '@/stores/passengers'
import { computed, ref, watch } from 'vue'

// Stores
const flightStore = useFlightSearchStore()
const passengersStore = usePassengersStore()
const contactStore = useContactStore()

const { pax, to, from, cabin } = flightStore
const activeTabIndex = ref(0)


// ------------------------------
// Generate Passenger Tabs
// ------------------------------
const tabItems = computed(() => {
  const items = []
  let id = 1

  const createTabs = (count, type) => {
    for (let i = 0; i < count; i++) {
      items.push({
        id: id++,
        label: `${type} ${i + 1}`,
        icon: 'bi bi-person',
        itenerary: `${from._id} âŸ¶ ${to._id}`,
        cabin: `${cabin} Class`,
      })
    }
  }

  createTabs(pax.adults, 'Adult')
  createTabs(pax.children, 'Child')
  createTabs(pax.infants, 'Infant')

  return items
})


// ------------------------------
// Local Refs (sync with Pinia)
// ------------------------------
const passengerForms = ref(passengersStore.passengers || [])
const contactForm = ref({ ...contactStore.contact })

// ------------------------------
// Copy First Guest to Contact
// ------------------------------
function copyFirstGuestDetails(isChecked) {
  if (isChecked && passengerForms.value.length > 0) {
    const firstPassenger = passengerForms.value[0]
    contactForm.value = {
      ...contactForm.value,
      title: firstPassenger.title || '',
      firstName: firstPassenger.firstName || '',
      lastName: firstPassenger.lastName || '',
      useFirstGuestDetails: true,
    }
  } else {
    contactForm.value = {
      ...contactForm.value,
      title: '',
      firstName: '',
      lastName: '',
      useFirstGuestDetails: false,
    }
  }
}

// ------------------------------
// Watchers
// ------------------------------

// When pax count changes, rebuild passenger forms
watch(
  tabItems,
  (newTabs) => {
    passengerForms.value = newTabs.map((_, index) => {
      return (
        passengerForms.value[index] || {
          title: '',
          firstName: '',
          lastName: '',
          day: '',
          month: '',
          year: '',
          nationality: '',
        }
      )
    })
  },
  { immediate: true }
)

// Sync passenger forms to Pinia
watch(passengerForms, (v) => passengersStore.setPassengers(v), { deep: true })

// Sync contact form to Pinia
watch(contactForm, (v) => contactStore.setContact(v), { deep: true })
</script>

<template>
  <div class="container-fluid d-flex flex-column p-0 flight guests-page">
    <main class="container-fluid px-2 pt-1 pb-2">
      <!-- Progress Bar -->
      <ProgressBar title="Guests" :steps="5" :currentStep="2" />

      <!-- Passenger Information -->
      <div class="px-2 mb-4">
        <h6 class="mb-3 normal-text-bold">Passenger Information</h6>
        <VerticalTabs :tabs="tabItems" v-model="activeTabIndex">
          <template #default="{ activeTab, index }">
            <PassengerForm v-if="tabItems[index]" :key="tabItems[index].id" v-model="passengerForms[index]"
              :routeLabel="activeTab.itenerary" :flightType="activeTab.cabin" />
          </template>
        </VerticalTabs>
      </div>

      <!-- Contact Information -->
      <div class="px-2">
        <h6 class="mb-3 normal-text-bold">Contact Information</h6>
        <ContactInfoForm v-model="contactForm" @useGuestDetails="copyFirstGuestDetails" />
      </div>

      <!-- Sticky Button -->
      <StickyButtonGroup primaryText="Continue" primaryLink="/add-ons" secondaryText="Back" secondaryLink="/flights"
        :showSecondary="true" />
    </main>
  </div>
</template>

<style scoped>
.guests-page {
  max-width: 800px;
}
</style>
